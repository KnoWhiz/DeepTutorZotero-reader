.view-popup {
	/*! rtl:begin:ignore */
	left: 0;
	/*! rtl:end:ignore */
	@include popover-pointer($width: 16px, $height: 8px);
	@include popup;
	z-index: 1;
}

.find-popup {
	@include popup;
	gap: 12px;
	padding: 8px;

	inset-inline-end: 15px;
	top: 15px;

	.row {
		display: flex;
	}

	.row.input {
		gap: 8px;

		.input-box {
			width: 100%;
			display: flex;

			&.loading {
				input {
					padding-inline-end: 25px;
				}

				.spinner-container {
					display: flex;
					align-items: center;
					margin-inline-start: -22px;

					.spinner {
						width: 16px;
						height: 16px;
						border: 3px solid #f3f3f3;
						border-top: 3px solid #7e7e7e;
						border-radius: 50%;
						animation: spin1 1.5s linear infinite;
					}
				}
			}
		}

		.group {
			display: flex;
			align-items: center;
			gap: 4px;
		}
	}

	.row.options {
		height: 16px;
		display: flex;
		align-items: flex-start;
		gap: 12px;

		.option {
			display: flex;
			align-items: center;
			gap: 6px;
		}
	}

	.row.result {
		height: 16px;
		display: flex;
		align-items: center;
		margin-top: -6px;
	}

	.result {
		white-space: nowrap;
		user-select: none;
	}

	.group {
		display: flex;
		align-items: center;
	}
}

.selection-popup {
	max-width: 198px;
	padding: 8px;
	gap: 8px;
	transition: max-width 0.15s ease-out;  // Smooth width transition

	// EXPANDED STATE: Colors + toggle side by side on same row
	&.deeptutor-translate-expanded {
		max-width: 450px;
		min-width: 350px;

		.selection-popup-row {
			flex-wrap: nowrap;  // Side by side
		}

		.colors {
			flex: 0 0 auto;  // Natural width
		}

		.tool-toggle {
			flex: 1 1 auto;  // Allow growing to fill space alongside colors
			min-width: 80px;  // Ensure minimum size
		}
	}

	// COLLAPSED STATE (default): Stacked layout
	.selection-popup-row {
		display: flex;
		flex-wrap: wrap;  // Allow stacking
		align-items: center;
		gap: 8px;
	}

	.colors {
		gap: 4px;
		display: flex;
		align-items: center;
		justify-content: flex-start;
		flex: 1 1 100%;  // Full width (row 1)
	}

	.color-button {
		width: 20px;
		height: 20px;
	}

	.tool-toggle {
		background: var(--fill-quinary);
		height: 22px;
		border-radius: 6px;
		padding: 1px;
		display: flex;
		flex: 1 1 100%;  // Full width (row 2) - stacked below colors
		box-shadow: 0px 0px 2px 0px #0000000D inset, 0px 0px 4px 0px #0000000D inset, 0px 0px 2px 0px #0000000D inset;

		.highlight, .underline {
			height: 20px;
			flex: 1;
			display: flex;
			justify-content: center;
			align-items: center;
			border-radius: 6px;
			color: var(--fill-secondary);
			border: 0.5px solid transparent;

			&.active, &:active, &.active-pseudo-class-fix {
				background: var(--material-button, #FFFFFF);
				border: 0.5px solid var(--fill-senary, #00000005);
				box-shadow: 0px 0px 0px 0.5px rgba(0, 0, 0, 0.05), 0px 0.5px 2.5px 0px rgba(0, 0, 0, 0.30);
			}

			&:active:not(.active), &.active-pseudo-class-fix:not(.active) {
				background-color: var(--color-button50);
				z-index: 1;
			}
		}
	}

	.wide-button {
		background: var(--material-button);
		text-align: center;
		box-shadow: 0px 0px 0px 0.5px rgba(0, 0, 0, 0.05), 0px 0.5px 2.5px 0px rgba(0, 0, 0, 0.30);
		width: 100%;
		color: var(--fill-primary);
		height: 22px;
	}

	.custom-sections {
		padding-top: 0;  // Remove extra top padding

		.section {
			padding: 0;  // Remove section padding
			border-top: none;  // Remove divider line
		}
	}
}

.selection-popup .deeptutor-translate-section {
	margin-top: 8px;
	padding-top: 8px;
	display: flex;
	flex-direction: column;
	gap: 8px;
	border-top: 1px solid var(--fill-quinary);  // Divider works in light & dark mode
}

// Pre-translate button: transparent by default, show box on hover
.selection-popup .deeptutor-translate-bar .wide-button.deeptutor-translate-button {
	background: transparent;
	box-shadow: none;

	&:hover {
		background: var(--material-button);
		box-shadow: 0px 0px 0px 0.5px rgba(0, 0, 0, 0.05), 0px 0.5px 2.5px 0px rgba(0, 0, 0, 0.30);
	}
}

.selection-popup .deeptutor-translate-bar {
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 8px;
}

.selection-popup .deeptutor-translate-bar .wide-button {
	width: auto;
}

.selection-popup .deeptutor-translate-button {
	display: inline-flex;
	align-items: center;
	gap: 6px;
	padding: 6px 12px;  // Increased horizontal padding for even spacing around text and chevron
}

.selection-popup .deeptutor-translate-caret {
	font-size: 12px;
	opacity: 0.8;
}

.selection-popup .deeptutor-translate-pane {
	display: flex;
	flex-direction: column;
	gap: 10px;  // Slightly more breathing room
	width: 100%;  // Full width of expanded popup
	padding: 0 16px;  // Symmetric padding for centered content
}

.selection-popup .deeptutor-translate-header {
	display: flex;
	align-items: center;
	justify-content: flex-start;
	gap: 8px;
	font-weight: 600;
	min-width: 0;
	overflow: visible;
	width: 100%;  // Ensure full width
	padding-left: 0;  // No left offset
	margin-left: 0;   // No negative margin
}

.selection-popup .deeptutor-translate-header button {
	white-space: nowrap;
	overflow: visible;  // Don't clip text
	margin-left: -8px;  // Pull left so T aligns with "Translate from" label below
	flex-shrink: 0;  // Prevent button from shrinking and clipping text
	width: auto;  // Override toolbar-button's 28px width
	height: auto;  // Override toolbar-button's 28px height
	padding: 4px 8px;  // Symmetric padding for hover state breathing room
}

.selection-popup .deeptutor-translate-controls {
	display: grid;
	grid-template-columns: 1fr auto 1fr;  // Source | Swap | Target
	gap: 8px;  // Tighter gap for 3-column layout
	width: 100%;  // Ensure full width for centering
	align-items: end;  // Align swap button with dropdowns
}

// Swap button wrapper - aligns with select elements (below labels)
.selection-popup .deeptutor-translate-swap {
	display: flex;
	align-items: center;
	justify-content: center;
	padding-top: 22px;  // Offset to align with selects (below labels)
}

.selection-popup .deeptutor-swap-btn {
	background: transparent;
	border: none;
	color: var(--fill-secondary);
	font-size: 24px;  // Larger icon for visibility
	font-weight: normal;  // Thinner appearance to match target design
	cursor: pointer;
	padding: 6px 8px;
	border-radius: 4px;
	transition: background 0.15s ease, color 0.15s ease;

	&:hover:not(:disabled) {
		background: var(--fill-quinary);
		color: var(--fill-primary);
	}

	&:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}
}

.selection-popup .deeptutor-translate-label {
	font-size: 13px;  // Larger to match Figma mockup
	color: var(--fill-secondary);
	margin-bottom: 6px;
}

.selection-popup .deeptutor-translate-select {
	width: 100%;
	padding: 8px;  // Increase padding
	border-radius: 6px;
	border: 1px solid var(--fill-quinary);
	background: var(--material-button);
	color: var(--fill-primary);
	font-size: 13px;  // Add explicit font size
}

.selection-popup .deeptutor-translate-actions {
	display: flex;
	gap: 8px;
	margin-top: 8px;
	justify-content: space-between;  // Clear left, Copy+Translate right
	align-items: center;
}

// Right-side button group (Copy + Translate)
.selection-popup .deeptutor-translate-actions-right {
	display: flex;
	gap: 8px;
}

.selection-popup .deeptutor-translate-actions button {
	flex: 0 0 auto;  // Don't stretch, natural width
	padding: 6px 12px;  // Smaller padding
	border-radius: 6px;
	font-weight: 500;
	height: auto;
	min-width: 85px;  // Increased to fit "Translating..." text
	white-space: nowrap;  // Prevent text wrapping/overflow
}

// Clear button - white background, blue text
.selection-popup .deeptutor-translate-btn-secondary {
	background: var(--material-button);
	color: var(--accent-blue);
	border: 1px solid var(--accent-blue);
	box-shadow: 0px 0px 0px 0.5px rgba(0, 0, 0, 0.05), 0px 0.5px 2.5px 0px rgba(0, 0, 0, 0.30);

	&:active:not(:disabled) {
		background: var(--fill-quarternary);
	}
}

// Translate button - blue background, white text
.selection-popup .deeptutor-translate-btn-primary {
	background: linear-gradient(180deg, rgba(255, 255, 255, 0.17) 0%, rgba(255, 255, 255, 0.00) 100%), var(--accent-blue);
	color: var(--accent-white);
	border: none;
	box-shadow: 0px 0px 0px 0.5px rgba(0, 0, 0, 0.05), 0px 0.5px 2.5px 0px rgba(0, 0, 0, 0.30);

	&:active:not(:disabled) {
		background: linear-gradient(to bottom, rgba(255, 255, 255, 0.25), rgba(0, 0, 0, 0.05)), darken(#0a6cf5, 6%);
	}
}

.selection-popup .deeptutor-translate-result {
	background: var(--material-button);
	color: var(--fill-primary);
	padding: 12px;  // Increase padding
	border-radius: 6px;
	font-size: 13px;
	line-height: 1.5;
	white-space: pre-wrap;
	width: 100%;
	min-height: 120px;  // Minimum height for taller appearance
	max-width: 400px;
	margin: 0 auto;  // Center the result box
	max-height: 300px;  // Reduce max to feel more proportionate
	overflow-y: auto;
	box-shadow: 0px 0px 0px 0.5px rgba(0, 0, 0, 0.05), 0px 0.5px 2.5px 0px rgba(0, 0, 0, 0.30);
	border: 1px solid var(--fill-quinary);
	box-sizing: border-box;
}

.selection-popup .deeptutor-translate-result.deeptutor-translate-error {
	color: #c62828;
}

.selection-popup .deeptutor-translate-muted {
	font-size: 11px;
	color: var(--fill-secondary);
}

.selection-popup .deeptutor-translate-badge-right {
	flex: 1 1 auto;
	text-align: right;
}

.selection-popup .deeptutor-translate-caret {
	transition: transform 0.2s ease;
}

.selection-popup .deeptutor-translate-pane .deeptutor-translate-caret {
	transform: rotate(180deg);
}

.preview-popup {
	display: flex;
	max-height: 60%;
	max-width: 60%;

	.inner {
		border-radius: inherit;
		max-height: 60%;
		overflow-y: auto;

		img {
			pointer-events: none;
		}
	}
}

.link-popup {
	padding: 4px;
}

.citation-popup {
	padding: 5px;

	.inner {
		width: 400px;
		max-height: 250px;
		overflow-y: auto;

		.reference-row {
			//user-select: none;
			//cursor: default;
			padding: 5px;
			border-radius: 5px;
			overflow-wrap: break-word;

			//&:hover, &:focus {
			//	outline: none;
			//	box-shadow: none;
			//	background: var(--fill-quinary);
			//}
		}
	}
}

.reference-popup {
	padding: 5px;
	width: 400px;
	max-height: 250px;

	.reference-row {
		//user-select: none;
		//cursor: default;
		padding: 5px;
		border-radius: 5px;
		word-break: break-all;

		//&:hover, &:focus {
		//	outline: none;
		//	box-shadow: none;
		//	background: var(--fill-quinary);
		//}
	}
}

.annotation-popup {
	width: 240px;

	.content {
		min-height: calc(
			2 * #{nem(4)}
			+ 3 * var(--note-font-size) * calc(4 / 3)
		);
		max-height: 10 * 16px + 8px;
		overflow-y: auto;
	}
}

.footnote-popup {
	border: 1px solid var(--color-background);

	&.loading {
		visibility: hidden;
	}

	iframe {
		display: flex;
		width: 100%;
		border: 0;
		border-radius: inherit;
		max-height: 300px;
	}
}

.image-popup {
	z-index: 1;
	position: absolute;
	inset: 0;
	cursor: zoom-out;
	user-select: none;

	& {
		background: transparent;
		transition: background-color 0.2s ease-out;
	}

	&.show {
		background: var(--color-background);
		transition: background-color 0.1s ease-out;
	}

	img {
		position: absolute;
		object-fit: contain;
		font-size: 0; // Hide alt text while loading

		top: var(--rect-top);
		left: var(--rect-left);
		width: calc(var(--rect-right) - var(--rect-left));
		height: calc(var(--rect-bottom) - var(--rect-top));
		padding: 0;
		transition: all 0.2s ease-in-out;
	}

	&.show img {
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		padding: 5px;
		font-size: inherit;
	}

	@media (prefers-reduced-motion: reduce) {
		&, &.show {
			&, & img {
				transition: none;
			}
		}
	}
}
